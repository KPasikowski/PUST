\documentclass[a4paper,titlepage,11pt,twosides,floatssmall]{mwrep}
\usepackage[left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm]{geometry}
\usepackage[OT1]{fontenc}
\usepackage{polski}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{url}
\usepackage{tikz}
\usetikzlibrary{arrows,calc,decorations.markings,math,arrows.meta}
\usepackage{rotating}
\usepackage[percent]{overpic}
\usepackage[cp1250]{inputenc}
\usepackage{xcolor}
\usepackage{pgfplots}
\usetikzlibrary{pgfplots.groupplots}
\usepackage{listings}
\usepackage{matlab-prettifier}
\definecolor{szary}{rgb}{0.95,0.95,0.95}
\usepackage{siunitx}
\sisetup{detect-weight,exponent-product=\cdot,output-decimal-marker={,},per-mode=symbol,binary-units=true,range-phrase={-},range-units=single}
\SendSettingsToPgf
%konfiguracje pakietu listings
\lstset{
	backgroundcolor=\color{szary},
	frame=single,
	breaklines=true,
}
\lstdefinestyle{customlatex}{
	basicstyle=\footnotesize\ttfamily,
	%basicstyle=\small\ttfamily,
}
\lstdefinestyle{customc}{
	breaklines=true,
	frame=tb,
	language=C,
	xleftmargin=0pt,
	showstringspaces=false,
	basicstyle=\small\ttfamily,
	keywordstyle=\bfseries\color{green!40!black},
	commentstyle=\itshape\color{purple!40!black},
	identifierstyle=\color{blue},
	stringstyle=\color{orange},
}
\lstdefinestyle{custommatlab}{
	captionpos=t,
	breaklines=true,
	frame=tb,
	xleftmargin=0pt,
	language=matlab,
	showstringspaces=false,
	%basicstyle=\footnotesize\ttfamily,
	basicstyle=\scriptsize\ttfamily,
	keywordstyle=\bfseries\color{green!40!black},
	commentstyle=\itshape\color{purple!40!black},
	identifierstyle=\color{blue},
	stringstyle=\color{orange},
}

%wymiar tekstu (bez ¿ywej paginy)
\textwidth 160mm \textheight 247mm

%ustawienia pakietu pgfplots
\pgfplotsset{
tick label style={font=\scriptsize},
label style={font=\small},
legend style={font=\small},
title style={font=\small}
}

\def\figurename{Rys.}
\def\tablename{Tab.}

%konfiguracja liczby p³ywaj¹cych elementów
\setcounter{topnumber}{0}%2
\setcounter{bottomnumber}{3}%1
\setcounter{totalnumber}{5}%3
\renewcommand{\textfraction}{0.01}%0.2
\renewcommand{\topfraction}{0.95}%0.7
\renewcommand{\bottomfraction}{0.95}%0.3
\renewcommand{\floatpagefraction}{0.35}%0.5

\begin{document}
\frenchspacing
\pagestyle{uheadings}

%strona tytu³owa
\title{\bf Sprawozdanie z æwiczenia laboratoryjnego nr 3 \vskip 0.1cm}
\author{Mateusz Koroœ, Ksawery Pasikowski, Mateusz Morusiewicz}
\date{2017}

\makeatletter
\renewcommand{\maketitle}{\begin{titlepage}
\begin{center}{\LARGE {\bf
Wydzia³ Elektroniki i Technik Informacyjnych}}\\
\vspace{0.4cm}
{\LARGE {\bf Politechnika Warszawska}}\\
\vspace{0.3cm}
\end{center}
\vspace{5cm}
\begin{center}
{\bf \LARGE Projektowanie uk³adów sterowania\\ (projekt grupowy) \vskip 0.1cm}
\end{center}
\vspace{1cm}
\begin{center}
{\bf \LARGE \@title}
\end{center}
\vspace{2cm}
\begin{center}
{\bf \Large \@author \par}
\end{center}
\vspace*{\stretch{6}}
\begin{center}
\bf{\large{Warszawa, \@date\vskip 0.1cm}}
\end{center}
\end{titlepage}
}
\makeatother

\maketitle

\tableofcontents
\chapter{Zad. 1}
Mo¿liwoœæ sterowania i pomiaru w komunikacji ze stanowiskiem zosta³a sprawdzona poprzez funkcjê readMeasurements oraz sendControls. Sygna³y steruj¹ce, które by³y obs³ugiwane to moc na grza³kach $G1$ i $G2$ oraz moc wiatraków $ W1 $ i $ W2 $, natomiast mierzona by³a temperatura $ T1 $ w otoczeniu grza³ki $ G1 $ oraz temperatura $ T2 $ w punkcie pomiêdzy grza³kami $ G1 $ i $ G2 $. W punkcie pracy, tzn. dla $ (W1, W2, G1, G2) = (50, 50, 29, 34) $ pomiar temperatury $ T1 $ wyniós³ $ \ang{36.5}C $, natomiast pomiar temperatury $ T2 $ wyniós³ $ \ang{38.5}C. $

\chapter{Zad. 2}
Skoki sterowania wynosi³y odpowiednio:
\begin{itemize}
	\item {\color{blue} $ \Delta u = 10 $}
	\item {\color{red} $ \Delta u = 20 $}
	\item {\color{green} $ \Delta u = 40 $}
\end{itemize}
Odpowiedzi skokowe widaæ na wykresach ~\ref{zad2_odpskok_u1y1}, ~\ref{zad2_odpskok_u2y1}, ~\ref{zad2_odpskok_u1y2} i ~\ref{zad2_odpskok_u2y2}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad2_u1y1.pdf}
	\caption{Skroœne odpowiedzi skokowe czujnika $T1$ dla ró¿nych skoków sterowania grza³ki $ G1 $ }
	\label{zad2_odpskok_u1y1}
\end{figure}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad2_u2y1.pdf}
	\caption{Skroœne odpowiedzi skokowe czujnika $T1$ dla ró¿nych skoków sterowania grza³ki $ G2 $ }
	\label{zad2_odpskok_u2y1}
\end{figure}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad2_u1y2.pdf}
	\caption{Skroœne odpowiedzi skokowe czujnika $T2$ dla ró¿nych skoków sterowania grza³ki $ G1 $ }
	\label{zad2_odpskok_u1y2}
\end{figure}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad2_u2y2.pdf}
	\caption{Skroœne odpowiedzi skokowe czujnika $T2$ dla ró¿nych skoków sterowania grza³ki $ G2 $ }
	\label{zad2_odpskok_u2y2}
\end{figure}


W³aœciwoœci statyczne obiektu mo¿na okreœliæ jako liniowe, gdy¿ zmiana sterowania powoduje liniow¹ zmianê sygna³u wyjœciowego. Charakterystyki statyczne zosta³y przedstawione na wykresie ~\ref{char_stat}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad2_charstat.pdf}
	\caption{Charatkterystyki statyczne}
	\label{char_stat}
\end{figure}
Wzmocnienie statyczne procesu dla ka¿dego z torów zosta³o obliczone ze wzoru:
\begin{equation*}
\begin{split}
K_{11} &= \frac{\Delta y_{1}}{\Delta u_{1}} \approx \num{0.26}\\
K_{12} &= \frac{\Delta y_{1}}{\Delta u_{2}} \approx \num{0.08}\\
K_{21} &= \frac{\Delta y_{2}}{\Delta u_{1}} \approx \num{0.20}\\
K_{22} &= \frac{\Delta y_{2}}{\Delta u_{2}} \approx \num{0.21}
\end{split}
\end{equation*}

\chapter{Zad. 3}
Najlepiej nadaj¹cymi siê odpowiedziami skokowymi sygna³u steruj¹cego by³y te dla skoku sterowania $ \Delta u = 40 $. Odpowiedzi te zosta³y przekszta³cone do postaci wykorzystywanej w algorytmie DMC w nastêpuj¹cy sposób:
\begin{lstlisting}[style=Matlab-editor]
Ysk = (s.Y1 - 36.5) / 40;
S = Ysk((Td+3):end);
\end{lstlisting}

Analogicznie zosta³a przekszta³cona odpowiedŸ skokowa drugiego czujnika:
\begin{lstlisting}[style=Matlab-editor]
Ysk = (s.Y2 - 38.5) / 40;
S = Ysk((Td+3):end);
\end{lstlisting}
Nastêpnie zosta³a wykonana aproksymacja odpowiedzi skokowych, do której zosta³ u¿yty cz³on inercyjny drugiego rzêdu z opóŸnieniem, opisany transmitancj¹:
$$ G(z) = \frac{b_{1}z^{-1} + b_{2}z^{-2}}{1+a_{1}z^{-1}+a_{2}z^{-2}}z^{-T_{d}} $$
Gdzie:
\begin{align}
\begin{aligned}
 a_{1} &= - \alpha_{1} - \alpha_{2} \\
 a_{2} &= \alpha_{1} \alpha_{2} \\
 \alpha_{1} &= e^{-\frac{1}{T_{1}}} \\
 \alpha_{2} &= e^{-\frac{1}{T_{2}}} \\
 b_{1} &= \frac{K}{T_{1} - T_{2}}[T_{1}(1- \alpha_{1}) - T_{2}(1- \alpha_{2})] \\
 b_{2} &= \frac{K}{T_{1} - T_{2}}[\alpha_{1}T_{2}(1- \alpha_{2}) - \alpha_{2}T_{1}(1- \alpha_{1})]
\end{aligned}
\end{align}

Po przekszta³ceniu powy¿szego równania otrzymujemy równanie ró¿nicowe postaci:
$$ y(k) = b_{1}u(k-T_{D}-1) + b_{2}u(k-T_{d}-2) - a_{1}y(k-1) - a_{2}y(k-2) $$

W celu doboru parametrów modelu zosta³a u¿yta funkcja wewnêtrzna œrodowiska MATLAB: fmincon(). Parametry modelu, zwrócone przez ow¹ funkcjê dla ró¿nych odpowiedzi skokowych:
\begin{itemize}
\item $G1, T1\rightarrow$  $T_{1}=\num{0.1077}, \quad T_{2}=\num{54.7428}, \quad T_{3}=\num{0.2446}$
\item $G1, T2\rightarrow$ $T_{1}=\num{0.1906}, \quad T_{2}=\num{377.9330}, \quad T_{3}=\num{0.8156}$
\item $G2, T1\rightarrow$ $T_{1}=\num{0.1733}, \quad T_{2}=\num{232.1743}, \quad T_{3}=\num{0.1750}$
\item $G2, T2\rightarrow$ $T_{1}=\num{0.1778}, \quad T_{2}=\num{149.0973}, \quad T_{3}=\num{0.3670}$
\end{itemize}

Parametry te zosta³y dobrane w taki sposób, aby b³¹d œredniokwadratowy miêdzy odpowiedzi¹ aproksymowan¹, a t¹ rzeczywist¹ by³ jak najmniejszy. Wartoœæ b³êdu w zale¿noœci od parametru $ T_{d} $ dla odpowiedzi skokowych sterowania(w kolejnoœci zgodnej z powy¿szym wypunktowaniem) widaæ na rysunku ~\ref{zad3_bledy} 
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad3_aproks.pdf}
	\caption{B³êdy œredniokwadratowe odpowiedzi skokowych sterowania w zale¿noœci od $ T_{d} $}
	\label{zad3_bledy}
\end{figure} 

Odpowiedzi skokowe obu czujników dla skoków sygna³ów steruj¹cych wraz z ich aproksymacjami widaæ na wykresach ~\ref{zad3_skok_u1y1}, ~\ref{zad3_skok_u1y2}, ~\ref{zad3_skok_u2y1}, ~\ref{zad3_skok_u2y2}. Jak widaæ na wykresach, funkcja aproksymuj¹ca jest bardzo dobrym przybli¿eniem oryginalnego przebiegu. Sumaryczny b³¹d jest niewielki.
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad3_u1y1.pdf}
	\caption{OdpowiedŸ skokowa czujnika $T1$ dla skoku sterowania na grza³ce $G1$}
	\label{zad3_skok_u1y1}
\end{figure}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad3_u1y2.pdf}
	\caption{OdpowiedŸ skokowa czujnika $T2$ dla skoku sterowania na grza³ce $G1$}
	\label{zad3_skok_u1y2}
\end{figure}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad3_u2y1.pdf}
	\caption{OdpowiedŸ skokowa czujnika $T1$ dla skoku sterowania na grza³ce $G2$}
	\label{zad3_skok_u2y1}
\end{figure}
\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad3_u2y2.pdf}
	\caption{OdpowiedŸ skokowa czujnika $T2$ dla skoku sterowania na grza³ce $G2$}
	\label{zad3_skok_u2y2}
\end{figure}

\chapter{Zad. 4}
\section{PID}
\begin{lstlisting}[style=Matlab-editor]

addpath('F:\SerialCommunication');
initSerialControl COM14

yzads = [40, 37];
Upp1 = 29;
Ypp1 = 36.5;
Upp2 = 34;
Ypp2 = 38.5;
Kk = 500;
U_min = 0;
U_max = 100;

% nastawy regulatora PID
% Kp = 3 ;
% Ti = 10 ;
% Td = 3.2 ;
Kp1 = 3;%5.94 ;
Ti1 = 25;%5.64 ;
Td1 = 0.7;%3.16 ;
Tp = 1;

Kp2 = 5;%5.94 ;
Ti2= 50;%5.64 ;
Td2= 0;%3.16 ;
Tp2= 1;

r2_1 = (Kp1 * Td1) / Tp ;
r1_1 = Kp1 * ( (Tp/(2*Ti1)) - 2*(Td1/Tp) - 1 ) ;
r0_1 = Kp1 * ( 1 + Tp/(2*Ti1) + Td1/Tp ) ;

r2_2 = (Kp2 * Td2) / Tp ;
r1_2 = Kp2 * ( (Tp/(2*Ti2)) - 2*(Td2/Tp) - 1 ) ;
r0_2 = Kp2 * ( 1 + Tp/(2*Ti2) + Td2/Tp ) ;

% warunki poczatkowe
u1(1:31) = Upp1 ;
U1(1:31) = Upp1 ;
y1(1:31) = Ypp1 ;
y2_1(1:31) = Ypp1 ;
e1(1:31) = 0 ;
delta_u1 = 0;
u2(1:31) = Upp2 ;
U2(1:31) = Upp2 ;
y2(1:31) = Ypp2 ;
y2_2(1:31) = Ypp2 ;
e2(1:31) = 0 ;
delta_u2 = 0;

index = 1;

yzad = yzads(1);   %skok wartosci zadanej
yzad2 = yzads(2);
yzadVec(1:30) = Ypp1;
yzadVec2(1:30) = Ypp2;
yzadVec(31:Kk) = yzad;
yzadVec2(31:Kk) = yzad2;

figure;
% glowna petla symulacji
for k = 3 : Kk

tmp = readMeasurements([1,2]);
y1(k) = tmp(1);
y2(k) = tmp(2);

e1(k) = yzadVec(k) - y1(k) ;
e1(k);
e2(k) = yzadVec2(k) - y2(k) ;


% regulator dla T1
u1(k) = r2_1 * e1(k-2) + r1_1 * e1(k-1) + r0_1 * e1(k) + u1(k-1);

if u1(k) > U_max - Upp1
u1(k) = U_max - Upp1;
elseif u1(k) < U_min - Upp1
u1(k) = U_min - Upp1;
end

U1(k) = u1(k) + Upp1;

% regulator dla T2
u2(k) = r2_2 * e2(k-2) + r1_2 * e2(k-1) + r0_2 * e2(k) + u2(k-1) ;

if u2(k) > U_max - Upp2
u2(k) = U_max - Upp2;
elseif u2(k) < U_min - Upp2
u2(k) = U_min - Upp2;
end

U2(k) = u2(k) + Upp2;



sendControls([ 1,2,5,6], [ 50, 50, U1(k), U2(k)]);


plot(y1); hold on;
plot(y2); hold off;
pause(0.01);

waitForNewIteration();
end

E1 = (yzadVec - y1)*(yzadVec - y1)';
E2 = (yzadVec2 - y2)*(yzadVec2 - y2)';
E = E1+E2;
\end{lstlisting}

\section{DMC}
\begin{lstlisting}[style=Matlab-editor]
addpath ('F:\SerialCommunication'); % add a path
initSerialControl COM14 % initialise com port
N = 200;
Nu = 50;
D=200;
kk=250;
lambda = 2;
Upp1 = 29;
Upp2 = 34;
U_max = 100;
U_min = 0;

Sapru1y1 = load('Sapr_T1_G1');
Sapru2y1 = load('Sapr_T1_G2');
Sapru1y2 = load('Sapr_T2_G1');
Sapru2y2 = load('Sapr_T2_G2');
s11=Sapru1y1.Sapr;
s12=Sapru2y1.Sapr;
s21=Sapru1y2.Sapr;
s22=Sapru2y2.Sapr;


ny=2;
nu=2;
y=zeros(ny,kk);
yzad=zeros(ny,kk);
yzad(1,1:kk)=40;
yzad(2,1:kk)=37;
u=zeros(nu,kk);
du=zeros(nu,kk);
dUP=cell(D-1,1);
dUP(1:D-1)={zeros(2,1)};
M=cell(N,Nu);

for i=1:N
for j=1:Nu
if (i>=j)
M(i,j)={[s11(i-j+1) s12(i-j+1); s21(i-j+1) s22(i-j+1)]};
else
M(i,j)={zeros(nu,ny)};
end
end
end
MP=cell(N,D-1);
for i=1:N
for j=1:D-1
if i+j<=D
MP(i,j)={[s11(i+j)-s11(j) s12(i+j)-...
s12(j); s21(i+j)-s21(j) s22(i+j)-s22(j)]};
else
MP(i,j)={[s11(D)-s11(j) s12(D)-s12(j); ...
 s21(D)-s21(j) s22(D)-s22(j)]};
end  
end
end
K=(cell2mat(M)'*cell2mat(M)+...
diag(ones(1,Nu*nu)*lambda))^(-1)*cell2mat(M)';
ku=K(1:nu,:)*cell2mat(MP);
ke1=sum(K(1,1:2:(N*ny)));
ke2=sum(K(1,2:2:(N*ny)));
ke3=sum(K(2,1:2:(N*ny)));
ke4=sum(K(2,2:2:(N*ny)));
figure;
for k=2:kk

y(1,k) = readMeasurements(1);
y(2,k) = readMeasurements(2);
du(:,k)=[ke1 ke2;ke3 ke4]*(yzad(:,k)-y(:,k))-ku*cell2mat(dUP);
for i=D-1:-1:2
dUP(i)=dUP(i-1);
end
dUP(1)={du(:,k)};
u(:,k)=u(:,k-1)+du(:,k);
if u(1,k) > U_max - Upp1
u(1,k) = U_max - Upp1;
elseif u(1,k) < U_min - Upp1
u(1,k) = U_min - Upp1;
end
if u(2,k) > U_max - Upp2
u(2,k) = U_max - Upp2;
elseif u(2,k) < U_min - Upp2
u(2,k) = U_min - Upp2;
end

sendControls ([1,2,5,6],[50, 50, u(1,k) + Upp1, u(2,k) + Upp2]);

plot(y(1,:)); hold on;
plot(y(2,:)); hold off;
pause(0.01);

waitForNewIteration();
end

E1=0;
E2=0;
for k=1:kk
E1=E1+((yzad(1,k)-y(1,k))^2);
E2=E2+((yzad(2,k)-y(2,k))^2);
end
E=E1+E2;


\end{lstlisting}
\chapter{Zad. 5}
Regulatory zosta³y przetestowane poprzez zmianê wartoœci zadanej z punktu pracy do pewnej wartoœci. Dla obu regulatorów by³a to zmiana najpierw na jednym czujniku(skok $T1$ do $\num{39}$), nastêpnie na drugim(skok $T2$ do $\num{41}$) a ostateczn¹ prób¹ by³ skok jednej wartoœci do wiêkszej ni¿ punkt pracy, natomiast drugiej do mniejszej($T1_{zad}=40, T2_{zad}=37$. W regulatorze PID na pierwszych dwóch wykresach widaæ uchyb ustalony, który zosta³ wyeliminowany w ostatecznej próbie poprzez zwiêkszenie wp³ywu cz³onu ca³kuj¹cego, co spowodowa³o znaczn¹ poprawê. Regulator DMC poradzi³ sobie bardzo dobrze we wszystkich przypadkach. Ostateczne parametry obu regulatorów:\\
PID: $ K_{p}=3 \quad T_{i}=25 \quad T_{d}=\num{0.7} $\\
DMC: $ D=200 \quad N=200 \quad N_{u}=50 $.\\
WskaŸniki jakoœci regulacji dla poszczególnych skoków:
\begin{itemize}
	\item PID
		\subitem $T1_{zad}=39\rightarrow E=\num{2018.9}$
		\subitem $T2_{zad}=41\rightarrow E = \num{1609.2}$
		\subitem $T1_{zad}=40,T2_{zad}=37\rightarrow E = \num{3109.7}$
	\item DMC
	\subitem $T1_{zad}=39\rightarrow E=\num{3240.8}$
	\subitem $T2_{zad}=41\rightarrow E = \num{3310}$
	\subitem $T1_{zad}=40,T2_{zad}=37\rightarrow E = \num{3561.3}$
\end{itemize}

\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad5_PID_1.pdf}
	\caption{Regulator PID przy skoku wartoœci zadanej $T1$ do $39$}
	\label{pid_1}
\end{figure}

\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad5_PID_3.pdf}
	\caption{Regulator PID przy skoku wartoœci zadanej $T2$ do $41$}
	\label{pid_2}
\end{figure}

\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad5_PID_2.pdf}
	\caption{Regulator PID przy skoku wartoœci zadanej $T1$ do $40$ oraz $T2$ do $37$}
	\label{pid_3}
\end{figure}

\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad5_DMC_1.pdf}
	\caption{Regulator DMC przy skoku wartoœci zadanej $T1$ do $39$}
	\label{dmc_1}
\end{figure}

\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad5_DMC_3.pdf}
	\caption{Regulator DMC przy skoku wartoœci zadanej $T2$ do $41$}
	\label{dmc_2}
\end{figure}

\begin{figure}[b]
	\centering
	\includegraphics[scale=1]{wykresy/zad5_DMC_2.pdf}
	\caption{Regulator DMC przy skoku wartoœci zadanej $T1$ do $40$ oraz $T2$ do $37$}
	\label{dmc_3}
\end{figure}
\end{document}

